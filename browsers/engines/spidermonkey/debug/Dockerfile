FROM debian

RUN mkdir -p /usr/workdir/
WORKDIR /usr/workdir/

# Install dependencies
RUN apt-get update && apt-get install -y gdb wget clang curl python python-dev build-essential python3 python3-pip autoconf2.13
RUN python3 -m pip install Mercurial
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y

# Bootstrap - non-interactive
#ADD non_interactive_bootstrap.sh non_interactive_bootstrap.sh
#RUN curl -o bootstrap.py https://hg.mozilla.org/mozilla-central/raw-file/default/python/mozboot/bin/bootstrap.py
#RUN chmod +x non_interactive_bootstrap.sh && apt-get install -y expect && ./non_interactive_bootstrap.sh || true

# Codebase
RUN apt-get update && apt-get install -y git curl
RUN git clone https://github.com/mozilla/gecko-dev.git
#ADD ./gecko-dev.git gecko-dev

# Build with selected commit hash
WORKDIR /usr/workdir/gecko-dev/
RUN git checkout -f 2e7e5f93bc63f7f1afacaab2423012f6d859cf6a
ADD blaze_custom.patch blaze_custom.patch
RUN git apply blaze_custom.patch

WORKDIR /usr/workdir/gecko-dev/js/src
ENV SHELL /bin/bash
RUN autoconf2.13
RUN apt-get install -y zlib1g-dev  pkg-config -y
RUN mkdir build.assets && cd build.assets && ../configure --enable-debug --disable-optimize 
RUN cd build.assets && make

#Debug
EXPOSE 4444
RUN wget -q -O- https://github.com/hugsy/gef/raw/master/scripts/gef.sh | sh
RUN echo set auto-load safe-path / >> /root/.gdbinit

# Add custom functions
ADD gdb-spidermonkey.py /root/gdb-spidermonkey.py
RUN echo source /root/gdb-spidermonekey.py >> /root/.gdbinit

RUN apt-get install -y vim procps

COPY exploits /root/
WORKDIR /root/
ENV LC_CTYPE C.UTF-8
#CMD gdb -q js 
#RUN apt-get install gdbserver -y
#CMD gdbserver 0.0.0.0:4444 /usr/workdir/gecko-dev/js/src/build.assets/js/src/js

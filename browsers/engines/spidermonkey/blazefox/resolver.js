
function ELF64_R_SYM(i) {
	return ((i) >> 32);
}

function ELF64_R_TYPE(i) {
	return ((i) & 0xffffffff);
}

let offsetof_e_phnum = 56n;
let offsetof_e_phoff = 32n;
let offsetof_p_type = 0n;
let offsetof_p_flags = 4n;
let offsetof_p_filesz = 32n;
let offsetof_p_offset = 8n;
let offsetof_p_vaddr = 16n;
let offsetof_d_tag = 0n;
let offsetof_d_un_d_val = 8n;
let offsetof_r_offset = 0n;
let offsetof_r_info = 8n;
let offsetof_st_name = 0n;
let offsetof_st_value = 8n;

let sizeof_Elf64_Phdr = 56n;
let sizeof_Elf64_Dyn = 16n;
let sizeof_Elf64_Rela = 24n;
let sizeof_Elf64_Sym = 24n;

let PT_LOAD = 1n;
let PT_DYNAMIC = 2n;

let PF_W = 2n;
let PF_X = 1n;

let DT_PLTGOT = 3n;
let DT_JMPREL = 23n;
let DT_PLTRELSZ = 2n;
let DT_SYMTAB = 6n;
let DT_STRTAB = 5n;
let DT_STRSZ = 10n;
let DT_RELAENT = 9n;
let DT_PLTREL = 20n;
let DT_RELA = 7n;
let DT_RELASZ = 8n;
let DT_HASH = 4n

let R_X86_64_JUMP_SLOT = 7n;
let R_X86_64_GLOB_DAT = 6n;

function arb_rstring(addr) {
	var str = "";

	while (1) {
		ch = arb_r1(addr);
		if (ch == 0)
			return str;
		str += String.fromCharCode(ch);
		addr += 1n;
	}
}

function elf_hash(sym_name) {
	var h=0;
	var g;

	for (var i = 0; i < sym_name.length; i++) {
		char = Number(sym_name.charCodeAt(i))
        h = (h << 4) + char;
        g = h & 0xf0000000;
		if (g) {
			h ^= g >> 24;
		}
		h &= ~g;
	}
	return h;
}

function resolve_symbol(base_addr, sym_name) {
	var symbols = new Array();
	var p_dyn, p_data, p_text;
	var e_phnum;
	var e_phoff;

	e_phnum = BigInt(arb_r2(base_addr + offsetof_e_phnum));
	e_phoff = BigInt(arb_r8(base_addr + offsetof_e_phoff));
	console.log("[+] Resolving symbol: " + sym_name + " from ELF image at 0x"+base_addr.toString(16));

	for (var i = 0n; i < e_phnum; i++) {
		var offset =  BigInt(e_phoff + sizeof_Elf64_Phdr * i);
		var p_type = BigInt(arb_r4(base_addr + offset + offsetof_p_type));
		var p_flags = BigInt(arb_r4(base_addr + offset + offsetof_p_flags));

		if (p_type == PT_LOAD && (p_flags & PF_X)) {
			p_text = i;
		} else if (p_type == PT_LOAD && (p_flags & PF_W)) {
			p_data = i;
		} else if (p_type == PT_DYNAMIC) {
			p_dyn = i;
		}
	}
	
	var p_dyn_filesz = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_dyn + offsetof_p_filesz));
	var p_dyn_offset = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_dyn + offsetof_p_offset));
	var p_dyn_vaddr = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_dyn + offsetof_p_vaddr));
	var p_text_offset = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_text + offsetof_p_offset));
	var p_text_vaddr = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_text + offsetof_p_vaddr));

	var strtab, symtab, dthash;

	for (var i = 0n; i < p_dyn_filesz/sizeof_Elf64_Dyn; i++) {
		var offset =  BigInt(p_dyn_vaddr + sizeof_Elf64_Dyn * i);
		var d_tag = BigInt(arb_r8(base_addr + offset + offsetof_d_tag));
		var d_val = BigInt(arb_r8(base_addr + offset + offsetof_d_un_d_val));

		switch (d_tag) {
		case DT_SYMTAB:
			symtab = d_val;
			break;
		case DT_STRTAB:
			strtab = d_val;
			break;
		}
	}
	
	function lookup(name_hash, symtab, strtab) {
		var idx=0n;
		while (true) {
			sym_offset = symtab + (idx * sizeof_Elf64_Sym);
			st_name = arb_r4(sym_offset + offsetof_st_name);
			sym_str = arb_rstring(strtab + st_name);
			
			if (sym_str == name_hash) {
				return base_addr + arb_r4(sym_offset + offsetof_st_value);
			}
			idx++;
		}
	}

	return lookup(sym_name, symtab, strtab);
}

function resolve_symbol_quick(base_addr, sym_name) {
	var symbols = new Array();
	var p_dyn, p_data, p_text;
	var e_phnum;
	var e_phoff;

	e_phnum = BigInt(arb_r2(base_addr + offsetof_e_phnum));
	e_phoff = BigInt(arb_r8(base_addr + offsetof_e_phoff));

	for (var i = 0n; i < e_phnum; i++) {
		var offset =  BigInt(e_phoff + sizeof_Elf64_Phdr * i);
		var p_type = BigInt(arb_r4(base_addr + offset + offsetof_p_type));
		var p_flags = BigInt(arb_r4(base_addr + offset + offsetof_p_flags));

		if (p_type == PT_LOAD && (p_flags & PF_X)) {
			p_text = i;
		} else if (p_type == PT_LOAD && (p_flags & PF_W)) {
			p_data = i;
		} else if (p_type == PT_DYNAMIC) {
			p_dyn = i;
		}
	}
	
	var p_dyn_filesz = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_dyn + offsetof_p_filesz));
	var p_dyn_vaddr = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_dyn + offsetof_p_vaddr));
	var strtab, symtab, dthash;

	for (var i = 0n; i < p_dyn_filesz/sizeof_Elf64_Dyn; i++) {
		var offset =  BigInt(p_dyn_vaddr + sizeof_Elf64_Dyn * i);
		var d_tag = BigInt(arb_r8(base_addr + offset + offsetof_d_tag));
		var d_val = BigInt(arb_r8(base_addr + offset + offsetof_d_un_d_val));

		switch (d_tag) {
		case DT_SYMTAB:
			symtab = d_val;
			break;
		case DT_STRTAB:
			strtab = d_val;
			break;
		case DT_HASH:
			dthash = d_val;
		default:
			break;
		}
	}

	function lookup(name_hash, hashtab, symtab, strtab) {
		var nbuckets;
		var nchains;
		var buckets;
		var chains;
		var h, idx;

		nbuckets = BigInt(arb_r4(hashtab + (0n * 4n)));
		nchains = BigInt(arb_r4(hashtab + (1n * 4n)));
		buckets = BigInt(hashtab + (2n* 4n));
		chains = BigInt(buckets + (nbuckets * 4n));
		h = BigInt(name_hash) % nbuckets;
		
		for (idx = arb_r4(buckets + (h * 4n)); idx != 0n; idx = arb_r4(chains + (idx * 4n))) {
			sym_offset = symtab + (idx * sizeof_Elf64_Sym);
			st_name = arb_r4(sym_offset + offsetof_st_name);
			sym_str = arb_rstring(strtab + st_name);
			console.log(sym_str);
			
			if (elf_hash(sym_str) == name_hash) {
				return base_addr + arb_r4(sym_offset + offsetof_st_value);
			}
		}
		return 0n;
	}

	sym_hash = elf_hash(sym_name);
	return lookup(sym_hash, dthash, symtab, strtab);
}

function resolve_relocs(base_addr, sym_type) {
	var symbols = new Array();
	var p_dyn, p_data, p_text;
	var e_phnum;
	var e_phoff;

	e_phnum = BigInt(arb_r2(base_addr + offsetof_e_phnum));
	e_phoff = BigInt(arb_r8(base_addr + offsetof_e_phoff));

	for (var i = 0n; i < e_phnum; i++) {
		var offset =  BigInt(e_phoff + sizeof_Elf64_Phdr * i);
		var p_type = BigInt(arb_r4(base_addr + offset + offsetof_p_type));
		var p_flags = BigInt(arb_r4(base_addr + offset + offsetof_p_flags));

		if (p_type == PT_LOAD && (p_flags & PF_X)) {
			p_text = i;
		} else if (p_type == PT_LOAD && (p_flags & PF_W)) {
			p_data = i;
		} else if (p_type == PT_DYNAMIC) {
			p_dyn = i;
		}
	}
	
	var p_dyn_filesz = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_dyn + offsetof_p_filesz));
	var p_dyn_vaddr = BigInt(arb_r8(base_addr + e_phoff + sizeof_Elf64_Phdr * p_dyn + offsetof_p_vaddr));
	var jmprel, pltrelsz, relasz, strtab, symtab, relaent, strsz, pltgot, rel;

	for (var i = 0n; i < p_dyn_filesz/sizeof_Elf64_Dyn; i++) {
		var offset =  BigInt(p_dyn_vaddr + sizeof_Elf64_Dyn * i);
		var d_tag = BigInt(arb_r8(base_addr + offset + offsetof_d_tag));
		var d_val = BigInt(arb_r8(base_addr + offset + offsetof_d_un_d_val));

		switch (d_tag) {
		case DT_PLTGOT:
			pltgot = d_val;
			break;
		case DT_JMPREL:
			jmprel = d_val;
			break;
		case DT_PLTRELSZ:
			pltrelsz = d_val;
			break;
		case DT_SYMTAB:
			symtab = d_val;
			break;
		case DT_STRTAB:
			strtab = d_val;
			break;
		case DT_STRSZ:
			strsz = d_val;
			break;
		case DT_RELAENT:
			relaent = d_val;
			break;
		case DT_RELA:
			rel = d_val;
			break;
		case DT_RELASZ:
			relasz = d_val;
			break;
		default:
			break;
		}
	}

	var centinel;
	var size;
	if (sym_type == R_X86_64_GLOB_DAT) {
		centinel = rel;
		size = relasz/relaent;
	} else {
		centinel = jmprel;
		size = pltrelsz/relaent;
	}
	
	for (var i = 0n; i < size; i++) {
		var offset =  BigInt(centinel + (sizeof_Elf64_Rela * i));
		var r_offset = BigInt(arb_r8(offset + offsetof_r_offset));
		var r_type = BigInt(arb_r4(offset + offsetof_r_info + 0n));
		var r_sym = BigInt(arb_r4(offset + offsetof_r_info + 4n));
		var sym_address, sym_name;

		if (BigInt(r_type) == sym_type) {
			var sym_offset =  BigInt(symtab + r_sym * sizeof_Elf64_Sym);
			if (sym_offset == 0n) {
				continue;
			}
			var st_name = BigInt(arb_r4(sym_offset + offsetof_st_name));
			if (st_name == 0n) {
				continue;
			}
			
			if (sym_type == R_X86_64_GLOB_DAT) {
				sym_address = base_addr + BigInt(arb_r4(sym_offset + offsetof_st_value));
			} else {
				sym_address = pltgot + (i+3n) * 8n;
			}
			
			sym_name = arb_rstring(strtab + st_name);
			//console.log("\t\t["+i+"] "+r_type+" Symbol " + sym_name + ":\t0x"+ sym_address.toString(16));
			symbols[sym_name] = sym_address;
		}
	}
	return symbols;
}

